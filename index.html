<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title> Daily Expense Tracker (INR)</title>
    <meta name="theme-color" content="#10b981"> <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* Define color variables for easy theme switching */
        :root {
            /* Light Mode Defaults */
            --bg-start: #f0fdfa;    /* Emerald 50 */
            --bg-end: #ccfbf1;      /* Emerald 100 */
            --text-primary: #1f2937; /* Gray 800 */
            --text-secondary: #6b7280; /* Gray 500 */
            --card-bg-rgb: 255, 255, 255; /* White for light mode transparency base */
            --border-color: rgba(0, 0, 0, 0.15);
            --shadow-color: rgba(0, 0, 0, 0.12);
            --emerald-color: #10b981; /* Emerald 500 */
        }

        .dark-mode {
            /* Dark Mode Variables */
            --bg-start: #0f172a;    /* Slate 900 (Deep Dark Background) */
            --bg-end: #020617;      /* Slate 950 */
            --text-primary: #f9fafb; /* White */
            --text-secondary: #9ca3af; /* Gray 400 */
            --card-bg-rgb: 0, 0, 0; /* Pure Black for dark mode transparency base */
            --border-color: rgba(255, 255, 255, 0.15);
            --shadow-color: rgba(0, 0, 0, 0.6);
            --emerald-color: #34d399; /* Emerald 400 (Brighter for contrast) */
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
            padding: 1rem;
            min-height: 100vh;
            color: var(--text-primary); 
            transition: background 0.5s ease;
        }
        #app-container {
            max-width: 600px; 
            margin-left: auto;
            margin-right: auto;
            width: 100%;
        }
        
        /* Pure Transparent Glassmorphism Effect for Cards and Modals */
        .glass-card {
            background-color: rgba(var(--card-bg-rgb), 0.4); /* Pure Transparent effect */
            backdrop-filter: blur(15px); /* Stronger blur for better separation */
            border: 1px solid var(--border-color); 
            box-shadow: 0 8px 20px var(--shadow-color); /* Stronger shadow */
            transition: all 0.3s ease;
        }

        /* Styling for inputs and selects (less transparent for readability) */
        .themed-input {
            background-color: rgba(var(--card-bg-rgb), 0.2); /* Slightly visible input background */
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        .themed-input::placeholder {
            color: var(--text-secondary);
        }

        /* Dynamic date input styling */
        input[type="date"] {
            color: var(--emerald-color);
            font-weight: 600;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
            text-align: center;
        }
        input[type="date"]:invalid::before {
            content: "Select Date";
            color: var(--text-secondary); 
            font-weight: 500;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            background: none;
            color: var(--emerald-color);
            cursor: pointer;
        }
        
        /* Category select input styling */
        #category-input:invalid {
            color: var(--text-secondary);
        }
        #category-input:valid {
            color: var(--text-primary); 
        }

        /* Highlight text color */
        .text-emerald-theme {
            color: var(--emerald-color);
        }
    </style>
</head>
<body>

    <div id="app-container">
        <header class="flex justify-between items-center mb-6 pt-2">
            <div>
                <h1 id="app-title" class="text-3xl font-extrabold text-emerald-theme tracking-tight">
                    Daily Expenses <span style="color: var(--text-primary)"> Tracking Tool</span>
                </h1>
                <p style="color: var(--text-secondary)" class="text-sm">Pro Tracker by Venkatesh </p>
            </div>
             <button id="theme-toggle" class="p-2 rounded-full shadow-lg transition-colors" style="background-color: var(--emerald-color); color: white;">
                <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                <svg id="moon-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </button>
        </header>
        
        <hr class="my-4" style="border-top: 1px solid var(--border-color);" />
        
        üìÖ Filter & Summary
      <br> </br>
        <div class="flex gap-2 mb-6">
            <div class="flex-1 glass-card p-2 rounded-xl shadow-md flex items-center justify-between">
                <input type="date" id="date-filter-summary" 
                       class="text-sm w-full p-1 focus:outline-none focus:ring-0 bg-transparent border-0" required>
                <button id="reset-date-btn-summary" class="text-gray-400 hover:text-emerald-theme p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
        </div>

        <div class="flex gap-3 mb-8">
            <div class="flex-1 glass-card p-4 rounded-2xl shadow-md border-l-4" style="border-left-color: var(--emerald-color);">
                <p class="text-xs font-bold uppercase" style="color: var(--text-secondary);">Total Spent <span id="summary-date-label" class="text-emerald-theme"></span></p>
                <p id="total-spent" class="text-2xl font-bold" style="color: var(--text-primary);">‚Çπ0</p>
            </div>
        </div>
        
        <hr class="my-4" style="border-top: 1px solid var(--border-color);" />

        üí∞ Add New Expense
<br> </br>
        <div id="input-card" class="glass-card p-5 rounded-2xl mb-8 relative overflow-hidden">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2" style="color: var(--text-primary);">
                <span class="text-emerald-theme">‚ú®</span> New Transaction
            </h2>
            <form id="expense-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label style="color: var(--text-secondary)" class="block text-xs font-semibold uppercase tracking-wider mb-1">Amount (‚Çπ)</label>
                        <div class="relative">
                            <span style="color: var(--text-secondary)" class="absolute left-3 top-3 font-bold">‚Çπ</span>
                            <input type="number" id="amount" step="1" required placeholder="0" inputmode="decimal"
                                   class="themed-input block w-full pl-8 rounded-xl shadow-inner p-2.5 focus:border-emerald-theme focus:ring-emerald-theme transition" />
                        </div>
                    </div>
                    <div>
                        <label style="color: var(--text-secondary)" class="block text-xs font-semibold uppercase tracking-wider mb-1">Category</label>
                        <select id="category-input" required
                                class="themed-input block w-full rounded-xl shadow-inner p-2.5 focus:border-emerald-theme focus:ring-emerald-theme transition"
                                data-selected="false">
                            <option value="" disabled selected>Select Category</option>
                            <option value="Food">Food üçî</option>
                            <option value="Shopping">Shopping üõçÔ∏è</option>
                            <option value="Transport">Transport üõ∫</option>
                            <option value="Bills">Bills üí°</option>
                            <option value="UPI">UPI/Transfer üí∏</option>
                            <option value="Other">Other üì¶</option>
                        </select>
                    </div>
                </div>
                <div>
                    <input type="text" id="description" placeholder="Description (e.g. Dosa and coffee)"
                           class="themed-input block w-full rounded-xl shadow-inner p-2.5 focus:border-emerald-theme focus:ring-emerald-theme transition" />
                </div>
                <button type="submit"
                        class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-emerald-500/50 transition active:scale-[0.98] flex justify-center items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Add Expense
                </button>
            </form>
        </div>
        
        <hr class="my-4" style="border-top: 1px solid var(--border-color);" />

        üìä Spending Trend
<br> </br>
        <div id="chart-card" class="glass-card p-4 rounded-2xl shadow-lg mb-8">
            <h2 class="text-lg font-semibold mb-3" style="color: var(--text-primary); border-bottom: 1px solid var(--border-color);" >Daily Spending Trend</h2>
            <canvas id="dailySpendingChart"></canvas>
            <p id="no-data-message" class="text-center italic py-4 hidden" style="color: var(--text-secondary);">Not enough data to graph (need at least 1 day of data).</p>
        </div>
        
        <hr class="my-4" style="border-top: 1px solid var(--border-color);" />

        üßæ Transactions List
<br> </br>
        <div id="list-card" class="glass-card p-2 rounded-2xl shadow-lg min-h-[200px] mb-8">
             <div class="flex justify-between items-start px-4 py-3 border-b" style="border-bottom-color: var(--border-color);">
                <h2 class="text-lg font-semibold" style="color: var(--text-primary); shrink-0 mt-1">Transactions</h2>
                
                <div class="flex gap-2">
                    <button id="delete-all-btn" 
                            class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg shadow-md transition active:scale-95 flex items-center gap-1 text-xs shrink-0">
                         <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        Delete All
                    </button>
                    <button id="export-btn" 
                            class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-lg shadow-md transition active:scale-95 flex items-center gap-1 text-xs shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>
                        Export
                    </button>
                </div>
            </div>
             <div class="flex justify-end items-center px-4 py-2 border-b" style="border-bottom-color: var(--border-color);">
                <div class="flex items-center gap-2 text-xs">
                    <select id="filter-type-select" class="font-medium themed-input rounded-lg focus:ring-emerald-theme focus:border-emerald-theme appearance-none transition p-1">
                        <option value="date" selected>Date</option>
                        <option value="category">Category</option>
                        <option value="all">All</option>
                    </select>

                    <input type="date" id="date-filter-transaction" class="font-medium bg-transparent border rounded-lg p-1 w-[110px]" style="border-color: var(--border-color);">
                    <select id="category-filter-transaction" class="font-medium bg-transparent border rounded-lg hidden p-1 w-[110px]" style="color: var(--emerald-color); border-color: var(--border-color);">
                        </select>
                </div>
            </div>
            
            <div id="expense-list" class="divide-y" style="border-color: var(--border-color);">
                <p id="no-expenses-message" class="text-center italic py-8" style="color: var(--text-secondary);">
                    No expenses yet or for the selected filters.
                </p>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-30 backdrop-blur-sm hidden z-50 p-4" aria-modal="true" role="dialog">
        <div class="glass-card rounded-xl max-w-xs mx-auto mt-20 p-6 space-y-4 transform transition-all duration-300">
            <div class="text-center">
                <div id="modal-icon-container" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-emerald-100 text-emerald-600">
                    </div>
                <h3 id="modal-title" class="mt-3 text-lg leading-6 font-bold" style="color: var(--text-primary);">Action</h3>
                <div class="mt-2">
                    <p id="modal-message" class="text-sm" style="color: var(--text-secondary);">Message here.</p>
                    <p id="modal-details" class="font-semibold text-sm mt-2 text-emerald-theme"></p>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-4">
                <button id="cancel-btn" type="button" class="inline-flex justify-center rounded-md border shadow-sm px-4 py-2 text-sm font-medium hover:bg-opacity-80 transition" style="background-color: var(--bg-start); color: var(--text-primary); border-color: var(--border-color);">
                    Cancel
                </button>
                <button id="confirm-btn" type="button" class="inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-sm font-medium text-white hover:bg-red-700 transition">
                    Confirm
                </button>
            </div>
        </div>
    </div>


    <script>
        // --- Global Chart Instance ---
        let dailyChart = null;
        
        // --- Local Storage Manager ---
        const STORAGE_KEY = 'kharcha_book_data_inr';
        const THEME_KEY = 'kharcha_book_theme';
        let expenses = [];
        let expenseToDeleteId = null; 
        
        // --- Filter States ---
        let currentFilterType = 'date'; 
        let currentFilterDate = null; 
        let currentFilterCategory = null; 

        // Helper to format date into YYYY-MM-DD string
        const toDateString = (date) => {
            if (!(date instanceof Date) || isNaN(date)) return '';
            return date.toISOString().split('T')[0];
        }

        // --- Categories ---
        const CATEGORIES = [
            'Food', 'Shopping', 'Transport', 'Bills', 'UPI', 'Other'
        ];
        
        function loadData() {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (raw) {
                expenses = JSON.parse(raw);
                expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Set initial filter state to today
                const today = toDateString(new Date());
                currentFilterDate = today;
                dateFilterSummaryInput.value = today;
                dateFilterTransactionInput.value = today;

                renderExpenses();
                updateChart();
                populateCategoryFilter(); 
            }
        }

        function saveData() {
            expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
            localStorage.setItem(STORAGE_KEY, JSON.stringify(expenses));
            renderExpenses();
            updateChart(); 
        }

        // --- DOM Elements ---
        const expenseForm = document.getElementById('expense-form');
        const expenseListEl = document.getElementById('expense-list');
        const totalSpentEl = document.getElementById('total-spent');
        const noExpensesMessageEl = document.getElementById('no-expenses-message');
        
        // Top filter for Summary
        const dateFilterSummaryInput = document.getElementById('date-filter-summary');
        const resetDateBtnSummary = document.getElementById('reset-date-btn-summary');

        // Transaction List Filters
        const filterTypeSelect = document.getElementById('filter-type-select');
        const dateFilterTransactionInput = document.getElementById('date-filter-transaction');
        const categoryFilterTransactionSelect = document.getElementById('category-filter-transaction');

        const summaryDateLabel = document.getElementById('summary-date-label');
        const exportBtn = document.getElementById('export-btn');
        const deleteAllBtn = document.getElementById('delete-all-btn'); 
        const chartCanvas = document.getElementById('dailySpendingChart');
        const noDataMessageEl = document.getElementById('no-data-message');
        
        // Modal Elements (Unified)
        const confirmModal = document.getElementById('confirm-modal');
        const cancelBtn = document.getElementById('cancel-btn');
        const confirmBtn = document.getElementById('confirm-btn');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalDetails = document.getElementById('modal-details');
        const modalIconContainer = document.getElementById('modal-icon-container');
        const categoryInput = document.getElementById('category-input');
        
        // Theme Elements
        const themeToggle = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');


        // --- Theme Management ---
        function applyTheme(isDarkMode) {
            document.body.classList.toggle('dark-mode', isDarkMode);
            localStorage.setItem(THEME_KEY, isDarkMode ? 'dark' : 'light');
            
            sunIcon.classList.toggle('hidden', isDarkMode);
            moonIcon.classList.toggle('hidden', !isDarkMode);

            updateChart(); 
            renderExpenses(); 
            
            // Fix modal icon container color on theme switch
            const emeraldColor = getComputedStyle(document.body).getPropertyValue('--emerald-color').trim();
            modalIconContainer.style.backgroundColor = isDarkMode ? emeraldColor + '33' : '#ecfdf5'; // emerald-100 equivalent
            modalIconContainer.style.color = emeraldColor;
        }

        function initializeTheme() {
            let storedTheme = localStorage.getItem(THEME_KEY);
            if (!storedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                storedTheme = 'dark';
            } else if (!storedTheme) {
                 storedTheme = 'light';
            }
            applyTheme(storedTheme === 'dark');
        }

        themeToggle.addEventListener('click', () => {
            const isDarkMode = document.body.classList.contains('dark-mode');
            applyTheme(!isDarkMode);
        });


        // --- Category Filter Population ---
        function populateCategoryFilter() {
            categoryFilterTransactionSelect.innerHTML = '<option value="">All Categories</option>';
            CATEGORIES.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat; 
                categoryFilterTransactionSelect.appendChild(option);
            });
            currentFilterCategory = categoryFilterTransactionSelect.value;
        }

        // --- Event Handlers (Input/Filter) ---

        expenseForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('amount').value);
            const category = categoryInput.value;
            const description = document.getElementById('description').value;

            if (!category || !amount) {
                if (!category) alert("Please select a valid category.");
                if (!amount) alert("Please enter a valid amount.");
                return;
            }

            const newExpense = {
                id: Date.now().toString(),
                amount,
                category,
                description: description.trim(),
                date: new Date().toISOString()
            };

            expenses.unshift(newExpense); 
            
            const today = toDateString(new Date());
            currentFilterType = 'date';
            currentFilterDate = today;
            
            // Reset filters to show the new transaction immediately
            dateFilterSummaryInput.value = today;
            dateFilterTransactionInput.value = today;
            filterTypeSelect.value = 'date';
            categoryFilterTransactionSelect.value = '';
            categoryFilterTransactionSelect.classList.add('hidden');
            dateFilterTransactionInput.classList.remove('hidden');

            saveData(); 
            expenseForm.reset();
            categoryInput.value = ""; 
        });

        // Filter event listeners (condensed)
        filterTypeSelect.addEventListener('change', (e) => { currentFilterType = e.target.value; if (currentFilterType === 'date') { dateFilterTransactionInput.classList.remove('hidden'); categoryFilterTransactionSelect.classList.add('hidden'); currentFilterDate = dateFilterTransactionInput.value || ''; currentFilterCategory = ''; } else if (currentFilterType === 'category') { dateFilterTransactionInput.classList.add('hidden'); categoryFilterTransactionSelect.classList.remove('hidden'); currentFilterCategory = categoryFilterTransactionSelect.value; currentFilterDate = ''; } else { dateFilterTransactionInput.classList.add('hidden'); categoryFilterTransactionSelect.classList.add('hidden'); currentFilterDate = ''; currentFilterCategory = ''; } renderExpenses(); updateChart(); });
        dateFilterTransactionInput.addEventListener('change', (e) => { currentFilterDate = e.target.value; dateFilterSummaryInput.value = currentFilterDate; renderExpenses(); updateChart(); });
        categoryFilterTransactionSelect.addEventListener('change', (e) => { currentFilterCategory = e.target.value; renderExpenses(); updateChart(); });
        dateFilterSummaryInput.addEventListener('change', (e) => { currentFilterDate = e.target.value; currentFilterType = 'date'; filterTypeSelect.value = 'date'; dateFilterTransactionInput.value = currentFilterDate; categoryFilterTransactionSelect.value = ''; currentFilterCategory = ''; categoryFilterTransactionSelect.classList.add('hidden'); dateFilterTransactionInput.classList.remove('hidden'); renderExpenses(); updateChart(); });
        resetDateBtnSummary.addEventListener('click', () => { currentFilterType = 'all'; currentFilterDate = ''; currentFilterCategory = ''; dateFilterSummaryInput.value = ''; dateFilterTransactionInput.value = ''; categoryFilterTransactionSelect.value = ''; filterTypeSelect.value = 'all'; categoryFilterTransactionSelect.classList.add('hidden'); dateFilterTransactionInput.classList.add('hidden'); renderExpenses(); updateChart(); });


        // --- Chart Logic ---

        function updateChart() {
             let chartDataExpenses = expenses;

            if (currentFilterType === 'date' && currentFilterDate) {
                chartDataExpenses = expenses.filter(e => toDateString(new Date(e.date)) === currentFilterDate);
            } else if (currentFilterType === 'category' && currentFilterCategory) {
                 chartDataExpenses = expenses.filter(e => e.category === currentFilterCategory);
            }

            const dailyTotals = chartDataExpenses.reduce((acc, expense) => {
                const dateKey = toDateString(new Date(expense.date));
                acc[dateKey] = (acc[dateKey] || 0) + expense.amount;
                return acc;
            }, {});

            const sortedDates = Object.keys(dailyTotals).sort((a, b) => new Date(a) - new Date(b));
            const recentDates = sortedDates.slice(-7); 
            
            const chartData = recentDates.map(date => dailyTotals[date]);
            const chartLabels = recentDates.map(date => {
                const dateObj = new Date(date + 'T00:00:00'); 
                return dateObj.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' });
            });

            if (chartData.length < 1) { 
                chartCanvas.style.display = 'none';
                noDataMessageEl.classList.remove('hidden');
            } else {
                chartCanvas.style.display = 'block';
                noDataMessageEl.classList.add('hidden');
            }
            
            const emeraldColor = getComputedStyle(document.body).getPropertyValue('--emerald-color').trim();
            const textSecondary = getComputedStyle(document.body).getPropertyValue('--text-secondary').trim();
            const borderColor = getComputedStyle(document.body).getPropertyValue('--border-color').trim();

            const data = {
                labels: chartLabels,
                datasets: [{
                    label: 'Daily Spending (‚Çπ)',
                    data: chartData,
                    backgroundColor: emeraldColor + 'cc', 
                    borderColor: emeraldColor,
                    borderWidth: 1,
                    borderRadius: 4,
                }]
            };

            const config = {
                type: 'bar', 
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Amount (‚Çπ)', color: textSecondary },
                            grid: { color: borderColor },
                            ticks: { color: textSecondary }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: textSecondary }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    }
                }
            };
            
            if (dailyChart) {
                dailyChart.destroy();
            }
            dailyChart = new Chart(chartCanvas, config);
        }


        // --- EXCEL EXPORT LOGIC (Date-specific filter confirmed) ---
        exportBtn.addEventListener('click', () => {
            let expensesToExport = expenses; 
            
            // Priority 1: Summary Date Filter (most explicit date selection)
            if (dateFilterSummaryInput.value) {
                const exportDate = dateFilterSummaryInput.value;
                expensesToExport = expenses.filter(e => toDateString(new Date(e.date)) === exportDate);
            } 
            // Priority 2: Transaction List Filters
            else if (currentFilterType === 'date' && currentFilterDate) {
                expensesToExport = expenses.filter(e => toDateString(new Date(e.date)) === currentFilterDate);
            } else if (currentFilterType === 'category' && currentFilterCategory) {
                expensesToExport = expenses.filter(e => e.category === currentFilterCategory);
            }
            // Else: Export All

            if (expensesToExport.length === 0) {
                alert("No expenses to export based on the current selection/data.");
                return;
            }
            
            let csvContent = "Date,Time,Amount (INR),Category,Description\n";

            expensesToExport.forEach(expense => {
                const dateObj = new Date(expense.date);
                const datePart = dateObj.toLocaleDateString('en-IN', { year: 'numeric', month: '2-digit', day: '2-digit' });
                const timePart = dateObj.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
                const sanitizedDescription = `"${expense.description ? expense.description.replace(/"/g, '""') : ''}"`;
                
                csvContent += `${datePart},${timePart},${expense.amount.toFixed(2)},${expense.category},${sanitizedDescription}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `kharcha_book_export_${toDateString(new Date())}.csv`);
            
            document.body.appendChild(link);
            link.click(); 
            document.body.removeChild(link);
            URL.revokeObjectURL(url); 
        });

        // --- Delete All Logic ---
        deleteAllBtn.addEventListener('click', () => {
            if (expenses.length === 0) {
                alert("No transactions to delete.");
                return;
            }
            showConfirmationModal(
                'Delete All Transactions',
                `Are you absolutely sure you want to delete **ALL** ${expenses.length} transactions? This action cannot be undone.`,
                'PERMANENT DELETION',
                handleDeleteAll
            );
        });

        function handleDeleteAll() {
            localStorage.removeItem(STORAGE_KEY);
            expenses = [];
            
            const today = toDateString(new Date());
            currentFilterDate = today;
            currentFilterCategory = '';
            currentFilterType = 'date';
            
            dateFilterSummaryInput.value = today;
            dateFilterTransactionInput.value = today;
            filterTypeSelect.value = 'date';

            renderExpenses();
            updateChart();
            closeModal();
        }


        // --- Unified Modal Logic ---
        let currentConfirmAction = null; 

        function showConfirmationModal(title, message, details, actionCallback, isDelete = true, expense = null) {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message;
            modalDetails.textContent = details;
            
            const emeraldColor = getComputedStyle(document.body).getPropertyValue('--emerald-color').trim();

            modalIconContainer.innerHTML = isDelete ? 
                `<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.3 16c-.77 1.333.192 3 1.732 3z" />
                </svg>` : 
                `<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 21h4c1 0 2-1 2-2v-3h2c.5 0 1-.5 1-1v-4c0-.5-.5-1-1-1h-2V6c0-1-1-2-2-2h-4c-1 0-2 1-2 2v3H6c-.5 0-1 .5-1 1v4c0 .5.5 1 1 1h2v3c0 1 1 2 2 2z"></path></svg>`;

            const isDarkMode = document.body.classList.contains('dark-mode');
            modalIconContainer.style.backgroundColor = isDarkMode ? emeraldColor + '33' : '#ecfdf5'; 
            modalIconContainer.style.color = emeraldColor;

            confirmBtn.style.backgroundColor = isDelete ? '#ef4444' : emeraldColor;
            confirmBtn.textContent = isDelete ? 'Delete' : 'Proceed';

            currentConfirmAction = actionCallback;
            confirmModal.classList.remove('hidden');
        }

        function initiateDelete(id) {
            const expense = expenses.find(e => e.id === id);
            if (!expense) return;

            expenseToDeleteId = id;
            showConfirmationModal(
                'Delete Expense',
                'Are you sure you want to permanently delete this transaction?',
                `‚Çπ${expense.amount.toFixed(0)} - ${expense.description || expense.category}`,
                confirmDelete
            );
        }
        
        function confirmDelete() {
            if (expenseToDeleteId) {
                expenses = expenses.filter(e => e.id !== expenseToDeleteId);
                saveData();
                closeModal();
            }
        }
        
        function closeModal() {
            confirmModal.classList.add('hidden');
            expenseToDeleteId = null;
            currentConfirmAction = null;
        }

        cancelBtn.addEventListener('click', closeModal);
        confirmBtn.addEventListener('click', () => {
            if (currentConfirmAction) {
                currentConfirmAction();
            }
        });
        confirmModal.addEventListener('click', (e) => {
            if (e.target === confirmModal) {
                closeModal();
            }
        });


        // --- Render List Function ---
        function renderExpenses() {
            expenseListEl.innerHTML = '';
            let filteredExpenses = expenses; 

            if (currentFilterType === 'date' && currentFilterDate) {
                 filteredExpenses = filteredExpenses.filter(e => toDateString(new Date(e.date)) === currentFilterDate);
            } else if (currentFilterType === 'category' && currentFilterCategory) {
                 filteredExpenses = filteredExpenses.filter(e => e.category === currentFilterCategory);
            }

            let summaryTotalExpenses = expenses;
            let summaryLabel = ' (All Time)';

            if (dateFilterSummaryInput.value) {
                const summaryDate = dateFilterSummaryInput.value;
                summaryTotalExpenses = expenses.filter(e => toDateString(new Date(e.date)) === summaryDate);
                const displayDate = new Date(summaryDate).toLocaleDateString('en-IN', { month: 'short', day: 'numeric', year: 'numeric' });
                summaryLabel = ` (for ${displayDate})`;
            }

            let summaryTotal = summaryTotalExpenses.reduce((sum, e) => sum + e.amount, 0);
            totalSpentEl.textContent = `‚Çπ${summaryTotal.toFixed(0)}`;
            summaryDateLabel.textContent = summaryLabel;


            if (filteredExpenses.length === 0) {
                noExpensesMessageEl.classList.remove('hidden');
            } else {
                noExpensesMessageEl.classList.add('hidden');
                
                // Get dynamic colors for rendering list items
                const emeraldColor = getComputedStyle(document.body).getPropertyValue('--emerald-color').trim();
                const textPrimary = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();
                const textSecondary = getComputedStyle(document.body).getPropertyValue('--text-secondary').trim();
                const cardBgRgb = getComputedStyle(document.body).getPropertyValue('--card-bg-rgb').trim();

                filteredExpenses.forEach(expense => {
                    
                    const dateObj = new Date(expense.date);
                    const dateStr = dateObj.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' });
                    const timeStr = dateObj.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });

                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-4 transition';
                    item.style.borderBottom = '1px solid var(--border-color)';
                    item.onmouseover = function() { this.style.backgroundColor = `rgba(${cardBgRgb}, 0.1)`; };
                    item.onmouseout = function() { this.style.backgroundColor = 'transparent'; };

                    item.innerHTML = `
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="p-2 rounded-lg text-xl shrink-0" style="background-color: ${emeraldColor}33; color: ${emeraldColor};">
                                ${getCategoryIcon(expense.category)}
                            </div>
                            <div class="min-w-0 flex-1 overflow-hidden">
                                <p class="font-medium truncate text-sm" style="color: ${textPrimary};">${expense.description || expense.category}</p>
                                <p class="text-xs" style="color: ${textSecondary};">${dateStr} @ ${timeStr}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 shrink-0">
                            <span class="font-bold" style="color: ${textPrimary};">‚Çπ${expense.amount.toFixed(0)}</span>
                            <button onclick="initiateDelete('${expense.id}')" class="p-1" style="color: ${textSecondary};">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        </div>
                    `;
                    expenseListEl.appendChild(item);
                });
            }
        }

        function getCategoryIcon(cat) {
            const map = { 'Food': 'üçî', 'Shopping': 'üõçÔ∏è', 'Transport': 'üõ∫', 'Bills': 'üí°', 'UPI': 'üí∏', 'Other': 'üì¶' };
            return map[cat] || 'üí∞';
        }
        
        // --- Initialization ---
        initializeTheme();
        loadData();
    </script>
</body>
</html>
